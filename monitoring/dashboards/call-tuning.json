{
  "id": null,
  "title": "Call Tuning",
  "timezone": "browser",
  "schemaVersion": 39,
  "version": 1,
  "refresh": "5s",
  "time": {"from": "now-1h", "to": "now"},
  "templating": {
    "list": [
      {
        "type": "query",
        "name": "call",
        "label": "Call ID",
        "hide": 0,
        "datasource": "Prometheus",
        "refresh": 2,
        "includeAll": false,
        "query": "label_values(ai_agent_stream_rx_bytes_total, call_id)",
        "current": {}
      },
      {
        "type": "query",
        "name": "ptype",
        "label": "Playback Type",
        "hide": 0,
        "datasource": "Prometheus",
        "refresh": 2,
        "includeAll": true,
        "allValue": ".*",
        "query": "label_values(ai_agent_stream_first_frame_seconds_bucket, playback_type)",
        "current": {}
      }
    ]
  },
  "panels": [
    {
      "type": "timeseries",
      "title": "Barge-in Config (ms)",
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
      "targets": [
        {"expr": "ai_agent_config_barge_in_ms{call_id=\"$call\"}", "refId": "A"}
      ]
    },
    {
      "type": "stat",
      "title": "Barge-in Threshold",
      "gridPos": {"h": 4, "w": 6, "x": 12, "y": 0},
      "targets": [
        {"expr": "ai_agent_config_barge_in_threshold{call_id=\"$call\"}", "refId": "A"}
      ]
    },
    {
      "type": "timeseries",
      "title": "Streaming Config (ms)",
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
      "targets": [
        {"expr": "ai_agent_config_streaming_ms{call_id=\"$call\"}", "refId": "A"}
      ]
    },
    {
      "type": "timeseries",
      "title": "Turn Detection (ms)",
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4},
      "targets": [
        {"expr": "ai_agent_config_turn_detection_ms{call_id=\"$call\"}", "refId": "A"}
      ]
    },
    {
      "type": "stat",
      "title": "Turn Detection Threshold",
      "gridPos": {"h": 4, "w": 6, "x": 18, "y": 0},
      "targets": [
        {"expr": "ai_agent_config_turn_detection_threshold{call_id=\"$call\"}", "refId": "A"}
      ]
    },
    {
      "type": "timeseries",
      "title": "First Frame (s) P50/P95",
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
      "targets": [
        {"expr": "histogram_quantile(0.5, sum by (le) (rate(ai_agent_stream_first_frame_seconds_bucket{call_id=\"$call\", playback_type=~\"$ptype\"}[15m])))", "refId": "A"},
        {"expr": "histogram_quantile(0.95, sum by (le) (rate(ai_agent_stream_first_frame_seconds_bucket{call_id=\"$call\", playback_type=~\"$ptype\"}[15m])))", "refId": "B"}
      ]
    },
    {
      "type": "timeseries",
      "title": "Segment Duration (s) P50/P95",
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
      "targets": [
        {"expr": "histogram_quantile(0.5, sum by (le) (rate(ai_agent_stream_segment_duration_seconds_bucket{call_id=\"$call\", playback_type=~\"$ptype\"}[15m])))", "refId": "A"},
        {"expr": "histogram_quantile(0.95, sum by (le) (rate(ai_agent_stream_segment_duration_seconds_bucket{call_id=\"$call\", playback_type=~\"$ptype\"}[15m])))", "refId": "B"}
      ]
    },
    {
      "type": "timeseries",
      "title": "Stream Starts (rate)",
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 24},
      "targets": [
        {"expr": "sum by (playback_type) (rate(ai_agent_stream_started_total{call_id=\"$call\", playback_type=~\"$ptype\"}[5m]))", "refId": "A"}
      ]
    },
    {
      "type": "timeseries",
      "title": "End Reasons (rate)",
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 24},
      "targets": [
        {"expr": "sum by (reason) (rate(ai_agent_stream_end_reason_total{call_id=\"$call\"}[5m]))", "refId": "A"}
      ]
    },
    {
      "type": "timeseries",
      "title": "Barge-in Reaction (s) P50/P95",
      "gridPos": {"h": 8, "w": 24, "x": 0, "y": 32},
      "targets": [
        {"expr": "histogram_quantile(0.5, sum by (le) (rate(ai_agent_barge_in_reaction_seconds_bucket{call_id=\"$call\"}[15m])))", "refId": "A"},
        {"expr": "histogram_quantile(0.95, sum by (le) (rate(ai_agent_barge_in_reaction_seconds_bucket{call_id=\"$call\"}[15m])))", "refId": "B"}
      ]
    }
  ]
}
